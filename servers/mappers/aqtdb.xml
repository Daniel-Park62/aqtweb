<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aqtdb">  
  <select id="tmaster_ListUid">
    SELECT code, desc1 name, cmpcode,enddate  from tmaster m join 
             (select apps from taqtuser where usrid = #{uid}) u 
      where m.appid rlike u.apps
  </select>
  <select id="tmaster_ListAll">
    SELECT a.*, a.desc1 name, 0 as chk from tmaster a 
  </select>
  <insert id="tmaster_Ins">
    INSERT INTO tmaster  (code, appid, lvl, desc1, cmpCode, tdate, endDate, tdir, tuser, thost, tport, tenv,pro) 
                VALUES (#{code}, #{appid}, #{lvl}, #{desc1},
                        #{cmpCode}, #{tdate}, #{endDate}, #{tdir}, 
                        #{tuser}, #{thost}, #{tport}, #{tenv},#{pro})
  </insert>
  <update id="tmaster_Upd">
    UPDATE tmaster SET 
	          appid=#{appid}, lvl=#{lvl}, desc1=#{desc1}, cmpCode=#{cmpCode}, tdate=#{tdate}, endDate=#{endDate}, 
            tdir=#{tdir}, tuser=#{tuser}, thost=#{thost}, tport=#{tport}, tenv=#{tenv},pro=#{pro}
       WHERE CODE = #{code} 
  </update>
  <delete id="tmaster_Del">
    delete from tmaster 
    <where>
      <foreach item="item" collection="list"
          open="code in (" separator="," close=")" >
            #{item}
      </foreach>
    </where>
  </delete>
  <delete id="ttcppacket_Erase">
    delete from ttcppacket 
    <where>
      <foreach item="item" collection="list"
          open="tcode in (" separator="," close=")" >
            #{item}
      </foreach>
    </where>
  </delete>
  <select id="tasksum_sel">
    SELECT *, if(scnt+fcnt=0,0,round(scnt*100/(scnt+fcnt),2)) srate FROM TTASKSUM order by TASK,LVL
  </select>
  <select id="vtr_SumByService">
    select t.tcode, t.uri svcid, s.svckor , count(1) tcnt, round(avg(t.svctime),3) avgt,
         sum(case when t.sflag = '1' then 1 else 0 end) scnt 
        , sum(case when t.sflag = '2' then 1 else 0 end) fcnt , s.cumcnt 
        from   vtcppacket t join tservice s on (t.uri = s.svcid and t.appid = s.appid)  
        WHERE 1=1 
         <if test="tcode != null"> and t.tcode = #{tcode} </if>
         <if test="task != null"> and s.task = #{task} </if>
         <if test="lvl != null"> and lvl = #{lvl} </if> 
         group by t.tcode, t.uri ORDER BY T.URI
  </select>
  <select id="vtrxlist_sel">
    SELECT code, type, lvl, desc1, cmpCode, tdate, endDate, 
        tdir, tuser, thost, tport, tenv, appid, svc_cnt, fsvc_cnt, 
        data_cnt, scnt, fcnt, spct, tot_svccnt 
    FROM vtrxlist WHERE appid rlike #{appid} order by tdate desc
  </select>
  <select id="tlevel_sel">
    <![CDATA[ 
      SELECT lvl, svc_cnt,data_cnt,scnt, if(data_cnt>0,round(scnt*100/data_cnt,2),0) srate FROM tlevel
    ]]>
  </select>
  <select id="taqtuser_All">
    SELECT  pkey, usrid, host, usrdesc, admin, apps, regdt FROM taqtuser a 
  </select>
  <select id="taqtuser_PassCheck">
    SELECT if( PASSWORD('${pass}') = pass1, 1,0) chk, admin, if(#{reqip} like host,1,0) hg, apps 
      FROM taqtuser where usrid = #{usrid} 
  </select>
  <update id="taqtuser_Upd">
    <foreach item="item" collection="list" separator=";">
      <![CDATA[ 
      UPDATE taqtuser 
      SET usrid=#{item.usrid}, host='${item.host}', 
          usrdesc=#{item.usrdesc}, admin=#{item.admin}, apps='${item.apps}' 
      WHERE pkey = ${item.pkey} 
      ]]>
     </foreach>
  </update>
  <update id="taqtuser_PassUpd">
     UPDATE taqtuser 
     SET pass1 = password('${npass}') 
     WHERE usrid = #{usrid} 
  </update>
  <insert id="taqtuser_Ins">
    INSERT INTO taqtuser 
         ( usrid, host, usrdesc, admin, apps ) 
        VALUES 
        <foreach item="r" collection="list" separator="," >
          (  #{r.usrid}, #{r.host}, #{r.usrdesc}, #{r.admin}, #{r.apps} )
      </foreach>
  </insert>
  <delete id="taqtuser_Del">
    delete from taqtuser 
    <where>
      <foreach item="item" collection="list"
          open="pkey in (" separator="," close=")" >
            #{item}
      </foreach>
    </where>

  </delete>

  <select id="tservice_List">
    SELECT pkey, appid, svcid,  svckor, svceng, task, manager, svckind 
      FROM tservice a 
     WHERE appid rlike '${appid}' and svcid rlike '${svcid}'
  </select>
  <update id="tservice_Upd">
    <foreach item="item" collection="list" separator=";">
      UPDATE tservice 
      SET appid=#{item.appid}, svcid='${item.scvid}', svckor='${item.svckor}',
          svceng='${item.svceng}', task=#{item.task}, manager='${item.manage}',svckind=#{item.svckind} 
      WHERE pkey = ${item.pkey} 
     </foreach>
  </update>
  <insert id="tservice_Ins">
    INSERT INTO tservice 
       ( appid, svcid,  svckor, svceng, task, manager, svckind) 
    VALUES 
    <foreach item="r" collection="list" separator="," >
      #r.appid, '${r.svcid}','${r.svckor}','${r.svceng}','${r.task}',#{r.manager},#{r.svckind}
    </foreach>
  </insert>
  <delete id="tservice_Del">
    delete from tservice 
    <where>
      <foreach item="item" collection="list"
          open="pkey in (" separator="," close=")" >
            #{item}
      </foreach>
    </where>
  </delete>

</mapper>