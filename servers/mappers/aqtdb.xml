<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="aqtdb">  
  <select id="tmaster_ListUid">
    SELECT code, desc1 name, cmpcode,enddate  from tmaster m join 
             (select apps from taqtuser where usrid = #{uid}) u 
      where m.appid rlike u.apps
  </select>
  <select id="tmaster_ListAll">
    SELECT a.*, a.desc1 name, 0 as chk from tmaster a 
  </select>
  <insert id="tmaster_Ins">
    INSERT INTO tmaster  (code, appid, lvl, desc1, cmpCode, tdate, endDate, tdir, tuser, thost, tport, tenv,pro) 
                VALUES (#{code}, #{appid}, #{lvl}, #{desc1},
                        #{cmpCode}, #{tdate}, #{endDate}, #{tdir}, 
                        #{tuser}, #{thost}, #{tport}, #{tenv},#{pro})
  </insert>
  <update id="tmaster_Upd">
    UPDATE tmaster SET 
	          appid=#{appid}, lvl=#{lvl}, desc1=#{desc1}, cmpCode=#{cmpCode}, tdate=#{tdate}, endDate=#{endDate}, 
            tdir=#{tdir}, tuser=#{tuser}, thost=#{thost}, tport=#{tport}, tenv=#{tenv},pro=#{pro}
       WHERE CODE = #{code} 
  </update>
  <delete id="tmaster_Del">
    delete from tmaster 
    <where>
      <foreach item="item" collection="list"
          open="code in (" separator="," close=")" >
            #{item}
      </foreach>
    </where>
  </delete>
  <delete id="ttcppacket_Erase">
    delete from ttcppacket 
    <where>
      <foreach item="item" collection="list"
          open="tcode in (" separator="," close=")" >
            #{item}
      </foreach>
    </where>
  </delete>
  <select id="tasksum_sel">
    SELECT *, if(scnt+fcnt=0,0,round(scnt*100/(scnt+fcnt),2)) srate FROM TTASKSUM order by TASK,LVL
  </select>
  <select id="vtr_SumByService">
    select t.tcode, t.uri svcid, s.svckor , count(1) tcnt, round(avg(t.svctime),3) avgt,
         sum(case when t.sflag = '1' then 1 else 0 end) scnt 
        , sum(case when t.sflag = '2' then 1 else 0 end) fcnt , s.cumcnt 
        from   vtcppacket t join tservice s on (t.uri = s.svcid and t.appid = s.appid)  
        WHERE 1=1 
         <if test="tcode != null"> and t.tcode = #{tcode} </if>
         <if test="task != null"> and s.task = #{task} </if>
         <if test="lvl != null"> and lvl = #{lvl} </if> 
         group by t.tcode, t.uri ORDER BY T.URI
  </select>
</mapper>